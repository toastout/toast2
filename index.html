<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>💃 RP 글쓰기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
      background: #fff;
      color: #222;
      transition: background 0.3s, color 0.3s;
      user-select: text;
    }
    body.dark {
      background: #121212;
      color: #ddd;
    }

    h3 {
      margin-top: 30px;
      margin-bottom: 10px;
    }

    .columns {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .column {
      flex: 1 1 45%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }
    textarea {
      flex: 1 1 auto;
      min-height: 180px;
      font-size: 16px;
      line-height: 1.4;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #fff;
      color: #222;
      resize: vertical;
      font-family: '맑은 고딕', 'Malgun Gothic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
    body.dark textarea {
      background: #1e1e1e;
      border-color: #555;
      color: #eee;
    }

    .copy-btn {
      margin-top: 6px;
      align-self: flex-end;
      background: #1976d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
      transition: background-color 0.3s;
    }
    .copy-btn:hover {
      background: #135ba1;
    }

    /* 미리보기 박스 */
    .preview {
      min-height: 120px;
      border: 1px solid #ccc;
      padding: 12px;
      white-space: pre-wrap;
      background: #fafafa;
      font-size: 16px;
      line-height: 1.5;
      border-radius: 4px;
      overflow-wrap: break-word;
    }
    body.dark .preview {
      background: #252525;
      border-color: #444;
      color: #eee;
    }

    /* 기호 버튼 모음 */
    .symbol-box {
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .symbol-box button {
      margin: 3px 4px 3px 0;
      font-size: 18px;
      padding: 3px 9px;
      cursor: pointer;
      border-radius: 4px;
      border: 1.5px solid #888;
      background: #fafafa;
      transition: background-color 0.2s;
      user-select: none;
    }
    .symbol-box button:hover {
      background: #d0e2ff;
    }
    body.dark .symbol-box button {
      background: #2b2b2b;
      border-color: #666;
      color: #ddd;
    }
    body.dark .symbol-box button:hover {
      background: #3a4a8f;
    }

    /* 강조, 하이라이팅 색상 */
    .quote {
      color: #2a58ff; /* 파란 대사 */
      background-color: #dbe5ff;
      padding: 0 3px;
      border-radius: 3px;
    }
    body.dark .quote {
      background-color: #2247b1;
      color: #a5c6ff;
    }

    .thought {
      color: #2e7d32; /* 초록 생각 */
      background-color: #d8f1d8;
      padding: 0 3px;
      border-radius: 3px;
    }
    body.dark .thought {
      background-color: #2a4b2a;
      color: #b7e1b7;
    }

    .desc {
      color: #666666; /* 회색 묘사 */
      font-style: italic;
      background-color: #f0f0f0;
      padding: 0 3px;
      border-radius: 3px;
    }
    body.dark .desc {
      background-color: #3a3a3a;
      color: #bbb;
    }

    .bold {
      font-weight: 700;
      background-color: #fff5b1;
      padding: 0 3px;
      border-radius: 3px;
      color: #6a4800;
    }
    body.dark .bold {
      background-color: #9e7f1d;
      color: #fffaf0;
    }

    .strike {
      text-decoration: line-through;
      color: #a00;
      background-color: #ffe0e0;
      padding: 0 3px;
      border-radius: 3px;
    }
    body.dark .strike {
      background-color: #731212;
      color: #ff8f8f;
    }

    .memo {
      font-size: 0.85em;
      color: #666;
      background-color: #f9f9f9;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: monospace;
      user-select: none;
    }
    body.dark .memo {
      background-color: #2c2c2c;
      color: #999;
    }

    /* 버전 선택창 + 삭제 버튼 */
    .version-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 2px;
      font-size: 14px;
      user-select: none;
    }
    body.dark .version-item {
      border-color: #444;
    }
    .version-item button {
      background: #e57373;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 700;
      border-radius: 3px;
      padding: 1px 6px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    .version-item button:hover {
      background: #b94545;
    }

    /* 도움말 모달 */
    #overlay {
      position: fixed;
      display: none;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
    }
    #helpModal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      color: #222;
      max-width: 360px;
      width: 90%;
      padding: 20px 25px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.4);
      z-index: 1001;
      font-size: 15px;
    }
    body.dark #helpModal {
      background: #222;
      color: #ddd;
      box-shadow: 0 0 15px rgba(80,80,80,0.8);
    }
    .modal-close {
      position: absolute;
      top: 7px; right: 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 18px;
      user-select: none;
      color: #888;
      transition: color 0.3s;
    }
    .modal-close:hover {
      color: #222;
    }
    body.dark .modal-close:hover {
      color: #ddd;
    }
  </style>
</head>
<body>
  <h1>💃 RP 글쓰기</h1>

  <div class="columns">
    <div class="column">
      <h3>🌟 참고 글 - {{char}} 대사</h3>
      <textarea id="refText" placeholder="참고할 내용을 붙여넣으세요."></textarea>
      <button class="copy-btn" onclick="copyText('refText')">복사</button>
    </div>
    <div class="column">
      <h3>🔥 내 글 작성 - {{user}} 대사</h3>
      <textarea id="myText" placeholder="여기에 글을 작성하세요."></textarea>
      <button class="copy-btn" onclick="copyText('myText')">복사</button>

      <div class="symbol-box" aria-label="기호 삽입">
        <strong>기호 삽입:</strong><br />
        <button onclick="insertSymbol('“')" aria-label='삽입 "“"'>“</button>
        <button onclick="insertSymbol('”')" aria-label='삽입 "”"'>”</button>
        <button onclick="insertSymbol('\'')" aria-label="삽입 '''">'</button>
        <button onclick="insertSymbol('*')" aria-label="삽입 *">*</button>
        <button onclick="insertSymbol('_')" aria-label="삽입 _">_</button>
        <button onclick="insertSymbol('~')" aria-label="삽입 ~">~</button>
        <button onclick="insertSymbol('/')" aria-label="삽입 /">/</button>
      </div>

      <div class="controls" aria-label="버전 및 기타 조작 버튼">
        <button onclick="saveVersion()">💾 저장</button>
        <button onclick="clearText()">🧹 초기화</button>
        <button onclick="downloadText()">📤 내보내기</button>
        <button onclick="toggleDark()">🌗 다크모드</button>
        <button onclick="openHelp()">❔ 도움말</button>
      </div>

      <div id="versionListContainer" aria-label="이전 버전 목록" style="margin-top:10px;">
        <strong>이전 버전:</strong>
        <div id="versionList" style="max-height: 160px; overflow-y: auto; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
          <!-- 버전 아이템 동적 추가 -->
        </div>
      </div>

      <div class="count-info" id="stats" aria-live="polite" style="margin-top: 8px; font-weight: 600;"></div>
    </div>
  </div>

  <h3>💭️ 내 글 미리보기 (실시간)</h3>
  <div class="preview" id="previewBox" aria-live="polite"></div>

  <!-- 도움말 모달 -->
  <div id="overlay" onclick="closeHelp()"></div>
  <div id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpDesc">
    <div class="modal-close" onclick="closeHelp()" aria-label="닫기">×</div>
    <h2 id="helpTitle">기호 사용법</h2>
    <div id="helpDesc">
      <p><strong>기호별 역할 안내</strong></p>
      <ul>
        <li><code>“</code> : 대사 시작 (파란색 하이라이팅)</li>
        <li><code>”</code> : 대사 끝 (파란색 하이라이팅)</li>
        <li><code>'</code> : 생각 표현 (초록색)</li>
        <li><code>*</code> : 묘사 강조 (회색, 이탤릭)</li>
        <li><code>_</code> : 메모 스타일 (작은 글씨, 회색 배경)</li>
        <li><code>~</code> : 삭제선 스타일</li>
        <li><code>/</code> : 굵은 강조</li>
      </ul>
      <p>특수문자 <code>‘ ’</code>는 모두 <code>'</code>로 자동 변환됩니다.</p>
      <p>버전 저장 후, 저장 목록에서 이전 버전을 클릭해 불러오거나 삭제할 수 있습니다.</p>
    </div>
  </div>

  <script>
    const refText = document.getElementById('refText');
    const myText = document.getElementById('myText');
    const previewBox = document.getElementById('previewBox');
    const versionList = document.getElementById('versionList');

    // 다크모드 상태 저장 및 불러오기
    function toggleDark() {
      document.body.classList.toggle('dark');
      localStorage.setItem('rp_darkmode', document.body.classList.contains('dark'));
    }
    // 페이지 로드시 다크모드 설정 불러오기
    if(localStorage.getItem('rp_darkmode') === 'true') {
      document.body.classList.add('dark');
    }

    // 특수문자 삽입
    function insertSymbol(sym) {
      const el = myText;
      const start = el.selectionStart;
      const end = el.selectionEnd;
      const val = el.value;
      el.value = val.substring(0, start) + sym + val.substring(end);
      el.selectionStart = el.selectionEnd = start + sym.length;
      el.focus();
      updatePreview();
      updateStats();
    }

    // 복사 함수
    function copyText(id) {
      const el = document.getElementById(id);
      const text = el.value;
      navigator.clipboard.writeText(text).then(() => {
        alert('복사되었습니다!');
      }).catch(() => {
        alert('복사에 실패했습니다. 수동으로 복사해주세요.');
      });
    }

    // 참고 글 하이라이트 적용 함수
    function highlightText(text) {
      if (!text) return '';

      // '‘' 와 '’'를 모두 ' 단일 인용부호로 통합
      text = text.replace(/[‘’]/g, "'");

      // Markdown 스타일 (강조, 삭제선 등)
      text = text.replace(/__(.*?)__/g, '<span class="bold">$1</span>');
      text = text.replace(/~~(.*?)~~/g, '<span class="strike">$1</span>');
      text = text.replace(/_(.*?)_/g, '<span class="memo">$1</span>');

      // 기호별 하이라이트
      // “ ” (대사) - 파란색
      text = text.replace(/“(.*?)”/g, '<span class="quote">“$1”</span>');
      // ' (생각) - 초록색
      text = text.replace(/'(.*?)'/g, '<span class="thought">\'$1\'</span>');
      // * (묘사) - 회색, 이탤릭
      text = text.replace(/\*(.*?)\*/g, '<span class="desc">*$1*</span>');

      return text;
    }

    // 실시간 미리보기 업데이트
    function updatePreview() {
      let rawText = myText.value;
      rawText = rawText.replace(/[‘’]/g, "'"); // ‘ ’ → '

      // Markdown 스타일 (강조, 삭제선 등)
      let html = rawText;
      html = html.replace(/__(.*?)__/g, '<span class="bold">$1</span>');
      html = html.replace(/~~(.*?)~~/g, '<span class="strike">$1</span>');
      html = html.replace(/_(.*?)_/g, '<span class="memo">$1</span>');

      // 기호별 하이라이트
      html = html.replace(/“(.*?)”/g, '<span class="quote">“$1”</span>');
      html = html.replace(/'(.*?)'/g, '<span class="thought">\'$1\'</span>');
      html = html.replace(/\*(.*?)\*/g, '<span class="desc">*$1*</span>');

      // 줄바꿈을 <br>로 변환
      html = html.replace(/\n/g, '<br>');

      previewBox.innerHTML = html;
    }

    // 참고 글에도 실시간 하이라이트 적용
    refText.addEventListener('input', () => {
      const highlighted = highlightText(refText.value);
      // 단순 미리보기처럼 처리 - 아래 바로 표시하진 않고 그냥 복사할 때 참고용
      // (원래 textarea에는 하이라이트 적용 어려워서 그냥 미리보기로 추가해도 됨)
    });

    // 내 글 작성에 입력시 미리보기, 통계 동시 업데이트
    myText.addEventListener('input', () => {
      updatePreview();
      updateStats();
    });

    // 글자수, 줄수, 분량 통계
    function updateStats() {
      const text = myText.value.trim();
      const charCount = text.length;
      const lineCount = text.split('\n').length;
      const wordCount = text.split(/\s+/).filter(Boolean).length;
      const stats = `글자수: ${charCount}자 / 줄수: ${lineCount}줄 / 단어수: ${wordCount}개`;
      document.getElementById('stats').innerText = stats;
    }

    // 버전 저장 & 관리
    const STORAGE_KEY = 'rp_versions';

    function saveVersion() {
      let content = myText.value.trim();
      if (!content) {
        alert('내용이 비어있으면 저장할 수 없습니다.');
        return;
      }
      let versions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      const timestamp = new Date().toLocaleString();
      versions.unshift({time: timestamp, text: content});
      if (versions.length > 20) versions.pop(); // 최대 20개 버전 유지

      localStorage.setItem(STORAGE_KEY, JSON.stringify(versions));
      renderVersionList();
      alert(`버전이 저장되었습니다 (${timestamp})`);
    }

    // 버전 목록 렌더링
    function renderVersionList() {
      let versions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      versionList.innerHTML = '';
      if(versions.length === 0) {
        versionList.innerHTML = '<em>저장된 버전이 없습니다.</em>';
        return;
      }
      versions.forEach((v, idx) => {
        const div = document.createElement('div');
        div.className = 'version-item';
        div.innerHTML = `<span>${v.time}</span>
          <button title="삭제" aria-label="버전 삭제" onclick="deleteVersion(${idx})">×</button>
        `;
        div.style.cursor = 'pointer';
        div.onclick = () => {
          if(confirm('이 버전을 불러오시겠습니까? 현재 작성 중인 내용은 사라집니다.')) {
            myText.value = versions[idx].text;
            updatePreview();
            updateStats();
          }
        };
        versionList.appendChild(div);
      });
    }

    // 버전 삭제
    function deleteVersion(idx) {
      let versions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if (!confirm('이 버전을 정말 삭제하시겠습니까?')) return;
      versions.splice(idx,1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(versions));
      renderVersionList();
    }

    // 초기화
    function clearText() {
      if(confirm('모든 작성 내용을 초기화하시겠습니까?')) {
        myText.value = '';
        updatePreview();
        updateStats();
      }
    }

    // 텍스트 파일로 내보내기
    function downloadText() {
      const text = myText.value;
      if (!text.trim()) {
        alert('내용이 비어있으면 내보낼 수 없습니다.');
        return;
      }
      const blob = new Blob([text], {type: 'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'my_rp_text.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // 도움말 열기/닫기
    function openHelp() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('helpModal').style.display = 'block';
    }
    function closeHelp() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('helpModal').style.display = 'none';
    }

    // 초기 로딩 시
    window.onload = () => {
      renderVersionList();
      updatePreview();
      updateStats();
    };
  </script>
</body>
</html>
